{% extends "base.html" %}

{% block input_form %}
      <h4>Unsupervized Clusterization</h4>
    {{ form.errors }}
{{ form.non_field_errors }}
      <form action="" method="post">
        {% csrf_token %}
        <div class="form-group-sm">
            <label for="tokenizer">Tokenizer:</label>
            <select class="form-control form-control-sm" name="tokenizer" id="tokenizer">
              <option value="nltk">NLTK/TreebankWordTokenizer</option>
              <option value="pyonmttok">pyonmttok/space</option>
            </select>
       </div>
        <div class="form-group-sm">
            <label for="w2v_size">Word2Vec Model Embedding Size:</label>
            <input name="w2v_size" class="form-control form-control-sm" id="w2v_size" type="text" placeholder="{{ settings.w2v_size }}">
        </div>
        <div class="form-group-sm">
            <label for="w2v_window">Word2Vec Slicing Window Size:</label>
            <input name="w2v_window" class="form-control form-control-sm" type="text" placeholder="{{ settings.w2v_window }}">
        </div>
        <div class="form-group-sm">
            <label for="min_samples">min_samples for DBSCAN</label>
            <input name="min_samples" class="form-control form-control-sm" type="text" placeholder="{{ settings.min_samples }}">
        </div>
          <br/>
          <br/>
        <button type="submit" value="Submit" class="btn btn-primary mb-2">Clusterize Errors</button>
       </form>
    {% endblock input_form %}
{% block content %}
        {% if submitted == True %}
        <h5>Clusters Statistics:</h5>
            <table id="statistics" class="table table-sm" width="90%">
                <thead>
                    <th>Cluster Name</th>
                    <th>First Entry</th>
                    <th>Cluster Size</th>
                    <th>Average Length of Error Messages</th>
                    <th>Std Length of Error Messages</th>
                    <th>Average Similarity</th>
                    <th>Std Similarity</th>
                </thead>
                <tbody>
                </tbody>
            </table>
            <h5>Select Cluster:</h5>
            <nav aria-label="Page navigation example">
            <ul class="pagination" id="clusters">
              </ul>
            </nav>
            <h5>Error Messages in selected cluster:</h5>
            <table id="cluster-results" class="table table-sm" width="90%">
                <thead>
                    <th>pandaid</th>
                    <th>error_message</th>
                    <th>modificationtime</th>
                    <th>error_code</th>
                </thead>
                <tbody>

                </tbody>
            </table>
        <script>
        $(document).ready(function() {
            var data = {{ clustered|safe }};
            var statistics = {{ statistics|safe }};
            console.log(data);
            console.log(statistics);
            var cluster_table = $('#cluster-results').DataTable({});
            var statistics_values = [];
            for (var key in statistics) {
                statistics_values.push(Object.values(statistics[key]));
            }
            console.log(statistics_values);
            var statistics_table = $('#statistics').DataTable({
                "data": statistics_values
            });
            $.each(data,function(key,value){
                var li = document.createElement("li");
                li.setAttribute('id',key);
                li.classList.add('page-item');
                var a = document.createElement('a');
                a.classList.add('page-link');
                a.href = '#';
                a.innerHTML = key;
                a.error_logs = data;
                li.appendChild(a);
                $('#clusters').append(li);
                a.onclick = function(event) {
                    event.preventDefault();
                    cluster_table.clear();
                    // Create DataTable for current cluster elements
                    var cluster_id = event.target.innerHTML;
                    var current_cluster = event.target.error_logs[cluster_id];
                    for (var i in current_cluster) {
                        var list = []
                        for (var key in current_cluster[i])
                            list.push(current_cluster[i][key]);
                        cluster_table.row.add(list)
                    }
                    cluster_table.draw();
                };
            });

        });
        </script>
    {% endif %}
{% endblock content %}
